<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Victor Igor</title>
  <meta name="description" content="Gosta de JavaScript ? Sim ? Então já podemos ser amigos.">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<!-- Social: Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@victorvoid_">
  <meta name="twitter:title" content="Victor Igor">
  <meta name="twitter:description" content="Gosta de JavaScript ? Sim ? Então já podemos ser amigos.">
  
  <meta property="twitter:image:src" content="http://victorvoid///images/blog-image.png">
  

<!-- Social: Facebook / Open Graph -->
  <meta property="fb:admins" content="1148441041847605" />
  <meta property="og:url" content="http://victorvoid///2016-01-01-group-aggregate/">
  <meta property="og:title" content="Victor Igor">
  
  <meta property="og:image" content="http://victorvoid///images/blog-image.png">
  
  <meta property="og:description" content="Gosta de JavaScript ? Sim ? Então já podemos ser amigos.">
  <meta property="og:site_name" content="Victor Igor">

<!-- Social: Google+ / Schema.org  -->
  <meta itemprop="name" content="Victor Igor"/>
  <meta itemprop="description" content="Gosta de JavaScript ? Sim ? Então já podemos ser amigos.">
  <meta itemprop="image" content="http://victorvoid///images/blog-image.jpg"/>

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/styl.css">
  <link rel="canonical" href="http://victorvoid///2016-01-01-group-aggregate/">
  <link rel="alternate" type="application/rss+xml" title="Victor Igor" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Victor Igor">
          <img src="/images/profile.png" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Victor Igor</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Gosta de JavaScript ? Sim ? Então já podemos ser amigos.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Victor Igor blog" class="blog-button">Blog</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/victorvoid_" title="@victorvoid_ on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            
              <!-- Facebook -->
              <li class="navigation__item">
                <a href="http://fb.me/victorcalangu" title="victorcalangu on Facebook" target="_blank">
                  <i class="icon icon-social-facebook"></i>
                  <span class="label">Facebook</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/victorvoid" title="victorvoid on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            
              <!-- Email -->
              <li class="navigation__item">
                <a href="mailto:victor.0w3@hotmail.com" title="Email victor.0w3@hotmail.com" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>
            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="30 Mar 2016" class="post-meta__date date">30 Mar 2016</time> &#8226; <span class="post-meta__tags">on </span>
    </div>
    <h1 class="post-title"></h1>
  </header>

  <section class="post">
    <p>Descobrindo a quantidade de elementos, limitando, ordenando e distinguindo valores de uma collection, agrupando.</p>

<h2 id="mongodb---aggregate-e-groups">MongoDB - Aggregate e Groups</h2>

<p>LOL Vamos continuar essa série pra ficar mais <del>hard core agora</del> legal com esses operadores.</p>

<p><img src="/images/group-aggregate/hc.gif" /></p>

<p>Antes de fatos aprendermos sobre Agreggate e Groups, vamos ver alguns tópicos importantes.
Para seguir os primeiros exemplos vamos usar a collection <span class="nc-s">restaurantes</span>
use o <a href="https://raw.githubusercontent.com/Webschool-io/be-mean-instagram/master/Apostila/module-mongodb/src/data/restaurantes.json">restaurantes.json</a> para importar.【ツ】<br /></p>

<h2 id="como-saber-a-quantidade-de-documentos-que-eu-tenho">Como saber a quantidade de documentos que eu tenho?</h2>

<p>Podemos usar a função length:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaurantes</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">length</span><span class="p">()</span></code></pre></figure>

<p>Porém dessa forma o resultado é ‘lento’, para isso temos uma função própria que é muito mais rápida que o <span class="nf-s">length( )</span></p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaurantes</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="mi">25359</span></code></pre></figure>

<p>Com o <span class="nf-s">count( )</span> também podemos usar querys que usamos no <span class="nf-s">find( )</span> para saber a quantidade do que queremos.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span><span class="na">borough</span><span class="p">:</span><span class="s1">'Bronx'</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaturantes</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="mi">2338</span></code></pre></figure>

<h2 id="distinct">Distinct</h2>

<p>Neste nosso restaurantes temos a seguinte estrutura:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w">  </span><span class="p">{</span><span class="w">
  </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"564d6c5af9e09ea567dade51"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"building"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2780"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"coord"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="mf">-73.98241999999999</span><span class="p">,</span><span class="w">
      </span><span class="mf">40.579505</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"street"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Stillwell Avenue"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"zipcode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11224"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"borough"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Brooklyn"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"cuisine"</span><span class="p">:</span><span class="w"> </span><span class="s2">"American "</span><span class="p">,</span><span class="w">
  </span><span class="nt">"grades"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"date"</span><span class="p">:</span><span class="w"> </span><span class="err">ISODate(</span><span class="s2">"2014-06-10T00:00:00Z"</span><span class="err">)</span><span class="p">,</span><span class="w">
      </span><span class="nt">"grade"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"score"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"date"</span><span class="p">:</span><span class="w"> </span><span class="err">ISODate(</span><span class="s2">"2013-06-05T00:00:00Z"</span><span class="err">)</span><span class="p">,</span><span class="w">
      </span><span class="nt">"grade"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"score"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"date"</span><span class="p">:</span><span class="w"> </span><span class="err">ISODate(</span><span class="s2">"2012-04-13T00:00:00Z"</span><span class="err">)</span><span class="p">,</span><span class="w">
      </span><span class="nt">"grade"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"score"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"date"</span><span class="p">:</span><span class="w"> </span><span class="err">ISODate(</span><span class="s2">"2011-10-12T00:00:00Z"</span><span class="err">)</span><span class="p">,</span><span class="w">
      </span><span class="nt">"grade"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"score"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Riviera Caterer"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"restaurant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"40356018"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Repare, e se quisermos saber todas as <span class="sx-s">borough</span> nesse universo de 25359 documentos?
Precisamos saber encontrar valores únicos de uma propriedade, pois ela pode se repetir em outros documentos. O <span class="nf-s">distinct( ) </span>vai nos ajudar com isso.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaurantes</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'borough'</span><span class="p">)</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="s2">"Brooklyn"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Manhattan"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Queens"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Staten Island"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Bronx"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Missing"</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<p>Ora se ele retorna um array, e usamos JavaScript, podemos usar um <span class="nf-s">length</span> para saber a quantidade não é ?</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaurantes</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'borough'</span><span class="p">).</span><span class="nx">length</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="mi">6</span></code></pre></figure>

<h2 id="tem-como-trazer-o-resultado-ordenado-">Tem como trazer o resultado ordenado ?</h2>

<p>Quem ae já estudou os algoritmos de ordenação, <del>sabe que dá muita raiva</del> sabe que existe vários algoritmos de ordenação e com vários casos cada um. Poxa e agora ? <del>se lascou, vai ter que implementar uma função para isso</del>
HEYY!!! Lembre, se estamos usando JavaScript, podemos usar a função <span class="nf-s">sort( )</span> para isso! e para os curiosos, ele usa o algorimo MergeSort, veja o código <a href="http://mxr.mozilla.org/seamonkey/source/js/src/jsarray.c">aqui</a>.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaurantes</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'borough'</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="s2">"Bronx"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Brooklyn"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Manhattan"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Missing"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Queens"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Staten Island"</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<p>Porém se quiser fazer o contrário, use a função <span class="nf-s">reverse( )</span></p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">restaurantes</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'borough'</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()</span></code></pre></figure>

<h2 id="limite">Limite</h2>

<p>Agora vamos usar uma collection <span class="nc-s">pokemons</span> nos próximos exemplos, use o <a href="https://raw.githubusercontent.com/wbruno/boas-praticas-js/master/pokemon-seed/pokemons.json">pokemons.json</a> para importar.</p>

<p>As vezes podemos querer colocar um limite de busca, assim limitando o número de resultados, como por exemplo:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span><span class="mi">0</span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pidgeotto"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Raticate"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Fearow"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Com ele podemos também usar o <span class="nf-s">skip( )</span>, para pedir para pular um determinado valor.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span><span class="mi">0</span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
 <span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></code></pre></figure>

<p>Assim ele pulou os 2 primeiros pokemons e retornou os próximos 5. Podemos fazer uma paginação com ele, assim mostrando de 5 em 5 por exemplo.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span><span class="mi">0</span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">skip</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">0</span><span class="p">)]</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span><span class="mi">0</span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">skip</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span><span class="mi">0</span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">skip</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span></code></pre></figure>

<h2 id="distinct-1">Distinct</h2>
<p>Geralmente em uma collection que possui muitos documentos, contém propriedades com valores iguais. Nesse exemplo de pokemons, repare que não existe um exclusivo <span class="sx-s">type</span> pra cada um, ele se repete em outros. Vamos descobrir quais e quantos <span class="sx-s">types</span> de pokemons existe na collection:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'types'</span><span class="p">).</span><span class="nx">length</span>
<span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'types'</span><span class="p">)</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="s2">"bug"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"poison"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"flying"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"normal"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"electric"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"water"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"fighting"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"psychic"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"grass"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"fairy"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"fire"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"rock"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ice"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ground"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"steel"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ghost"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"dark"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"dragon"</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<h2 id="agrupamento">Agrupamento</h2>
<p><img src="/images/group-aggregate/elements-2.png" /></p>

<p>Podemos agrupar cada tipo de pokemons e poder mandar contar quantos pokemons tem aquele valor por exemplo, tudo isso usando a função <span class="nf-s">group( )</span>.</p>

<p>O <strong>group</strong> tem no total 6 propriedades que podemos utilizar, vamos usar algumas delas para nossos exemplos.</p>

<ol>
  <li>key</li>
  <li>reduce</li>
  <li>initial</li>
  <li>keyf</li>
  <li>cond</li>
  <li>finalize</li>
</ol>

<p>Vamos ver algumas delas! (͡๏̯͡๏)۶</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//exemplo 1</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">group</span><span class="p">({</span>
  <span class="na">initial</span><span class="p">:</span> <span class="p">{</span><span class="na">total</span> <span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
  <span class="na">reduce</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">curr</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
    <span class="nx">curr</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">type</span><span class="p">]){</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="o">++</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">934</span><span class="p">,</span><span class="w">
    </span><span class="nt">"normal"</span><span class="p">:</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w">
    </span><span class="nt">"flying"</span><span class="p">:</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span><span class="w">
    </span><span class="nt">"poison"</span><span class="p">:</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w">
    </span><span class="nt">"bug"</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w">
    </span><span class="nt">"electric"</span><span class="p">:</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w">
    </span><span class="nt">"water"</span><span class="p">:</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w">
    </span><span class="nt">"fighting"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w">
    </span><span class="nt">"psychic"</span><span class="p">:</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w">
    </span><span class="nt">"grass"</span><span class="p">:</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w">
    </span><span class="nt">"fairy"</span><span class="p">:</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w">
    </span><span class="nt">"fire"</span><span class="p">:</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w">
    </span><span class="nt">"rock"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w">
    </span><span class="nt">"ice"</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w">
    </span><span class="nt">"ground"</span><span class="p">:</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w">
    </span><span class="nt">"steel"</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w">
    </span><span class="nt">"ghost"</span><span class="p">:</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w">
    </span><span class="nt">"dark"</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w">
    </span><span class="nt">"dragon"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<h3 id="entendo-o-exemplo-1">Entendo o exemplo 1</h3>

<p>Usamos algumas propriedades do group, que é o <span class="nf-s">init</span> e o <span class="nf-s">reduce</span>:
No init inicializamos a variável total para contar e em seguida o reduce onde toda a mágica acontece.
No reduce escrevemos uma função que recebe o <span class="sr-s">curr</span> como parâmetro e será de fato cada objeto, e o <span class="sr-s">result</span> que é responsável pelo resultado, em seguida acesso o tipo de cada pokemon e faço um <span class="kd-s">forEach</span> para descobrir quantos pokemons tem esse tipo.</p>

<h3 id="colocando-condies">Colocando condições</h3>
<p>Vamos usar a propriedade <span class="kd-s">cond</span> para informar nossa condição.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">group</span><span class="p">({</span>
  <span class="na">initial</span><span class="p">:{</span><span class="na">total</span> <span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
  <span class="na">cond</span>   <span class="p">:{</span><span class="na">defense</span><span class="p">:</span> <span class="p">{</span><span class="na">$gt</span><span class="p">:</span><span class="mi">200</span><span class="p">}},</span>
  <span class="na">reduce</span> <span class="p">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">curr</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
    <span class="nx">curr</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">type</span><span class="p">]){</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="o">++</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nt">"rock"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nt">"bug"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<h2 id="finalize">Finalize</h2>
<p>Ao contrários das outras propriedades que é sempre chamada para cada documento, o <span class="kd-s">finalize</span> é chamada apenas ao final da execução.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//exemplo 2</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">group</span><span class="p">({</span>
  <span class="na">initial</span><span class="p">:</span> <span class="p">{</span><span class="na">total</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">defense</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">attack</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span>
  <span class="na">reduce</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">result</span><span class="p">){</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">defense</span> <span class="o">+=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">defense</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">attack</span>  <span class="o">+=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">attack</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="na">finalize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
     <span class="nx">result</span><span class="p">.</span><span class="nx">media_defense</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">defense</span><span class="o">/</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">;</span>
     <span class="nx">result</span><span class="p">.</span><span class="nx">media_attack</span>  <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">attack</span><span class="o">/</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">620</span><span class="p">,</span><span class="w">
    </span><span class="nt">"defense"</span><span class="p">:</span><span class="w"> </span><span class="mi">44363</span><span class="p">,</span><span class="w">
    </span><span class="nt">"attack"</span><span class="p">:</span><span class="w"> </span><span class="mi">47022</span><span class="p">,</span><span class="w">
    </span><span class="nt">"media_defense"</span><span class="p">:</span><span class="w"> </span><span class="mf">71.55322580645161</span><span class="p">,</span><span class="w">
    </span><span class="nt">"media_attack"</span><span class="p">:</span><span class="w"> </span><span class="mf">75.84193548387097</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<blockquote class="trivia">
<p><strong class="cabecalho">Exemplo 2 ? WTF</strong>
Usamos o <span class="kd-s">finalize</span> para sabermos a média de <span class="sx-s">attacks</span> e <span class="sx-s">defenses</span>, pra isso ao final de tudo pegamos a soma deles e dividimos pela quantidade. Simples não é? ( ͡°﻿ ͜ʖ ͡°)</p>
</blockquote>

<h2 id="aggregate">Aggregate</h2>
<p>Temos 3 abordagens para agregações, cada uma com sua característica e propósitos para cada situação, veremos a <em>aggregation pipeline.</em></p>

<h4 id="aggregation-pipeline-">Aggregation Pipeline ?</h4>
<p><img src="/images/group-aggregate/dog-mordida.gif" /></p>

<p>Ele é basicamente um framework para executar uma série de transformações de dados em um documento. Existe 10 tipos de transformações que podem ser utilizados.</p>

<ol>
  <li><a href="https://docs.mongodb.org/v3.0/reference/operator/aggregation/geoNear/">$geoNear</a></li>
  <li><a href="https://docs.mongodb.org/v3.0/reference/operator/aggregation/match/">$match</a></li>
  <li><a href="https://docs.mongodb.org/v3.0/reference/operator/aggregation/project/">$project</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/redact/">$redact</a></li>
  <li><a href="https://docs.mongodb.org/v3.0/reference/operator/aggregation/unwind/">$unwind</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/group/">$group</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/limit/">$limit</a></li>
  <li><a href="https://docs.mongodb.org/v3.0/reference/operator/aggregation/skip/">$skip</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/sort/">$sort</a></li>
  <li><a href="https://docs.mongodb.org/v3.0/reference/operator/aggregation/out/">$out</a></li>
</ol>

<p>Vamos ver alguns deles para nossos exemplos. =) <br />
Similar ao <strong>group</strong>, podemos fazer a mesma coisa em menor tamanho de linhas. Basicamente tudo que fazemos com o group, podemos fazer com o <strong>aggregate</strong>.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//exemplo 3</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">({</span>
  <span class="na">$group</span><span class="p">:{</span>
      <span class="na">_id</span><span class="p">:{},</span>
      <span class="na">media_defense</span><span class="p">:{</span> <span class="na">$avg</span><span class="p">:</span> <span class="s1">'$defense'</span><span class="p">},</span>
      <span class="na">media_atack</span><span class="p">:</span> <span class="p">{</span><span class="na">$avg</span><span class="p">:</span> <span class="s1">'$attack'</span><span class="p">},</span>
      <span class="na">defense</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="s1">'$defense'</span><span class="p">},</span>
      <span class="na">attack</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="s1">'$attack'</span><span class="p">},</span>
      <span class="na">total</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"result"</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"_id"</span><span class="p">:</span> <span class="p">{</span>

      <span class="p">},</span>
      <span class="s2">"media_defense"</span><span class="p">:</span> <span class="mf">71.55322580645161</span><span class="p">,</span>
      <span class="s2">"media_atack"</span><span class="p">:</span> <span class="mf">75.84193548387097</span><span class="p">,</span>
      <span class="s2">"defense"</span><span class="p">:</span> <span class="mi">44363</span><span class="p">,</span>
      <span class="s2">"attack"</span><span class="p">:</span> <span class="mi">47022</span><span class="p">,</span>
      <span class="s2">"total"</span><span class="p">:</span> <span class="mi">620</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">"ok"</span><span class="err">:</span> <span class="mi">1</span>
<span class="p">}</span></code></pre></figure>

<p>Você vai ver que deu o mesmo valor do <em>exemplo 1</em></p>

<h3 id="entendendo-o-exemplo-3">Entendendo o exemplo 3</h3>
<p>No <em>aggregate</em> tenho uma propriedade chamada <span class="nf-s">$group</span>, aliás todas as funções do <em>aggregate</em> começa com o<strong> $</strong>. O <strong>_id</strong> serve para definir o agrupamento, por exemplo se eu quisesse agrupar por <em>data</em> ou <em>tempo</em>, mas como nesse exemplo não vamos precisar separar nada, fica vazio. Usei a função <span class="nf-s">$avg</span> para trazer a média da coluna <span class="sx-s">defense</span> e <span class="sx-s">attack</span>, a <span class="nf-s">$sum</span> foi para trazer o somatório de cada, é importante destacar que ao definir a coluna precisamos colocar o <strong>$</strong> no início para informar o mongo que ela é uma coluna.</p>

<p>Você deve ter reparado na facilidade que deu usando esses operadores <strong>$sum</strong> e <strong>$svg</strong> não é ? Pois bem, eles são operadores acumuladores, temos 10 no total que salva sua vida. ٩(-̮̮̃•̃)۶</p>

<ol>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/sum/">$sum</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/avg/">$avg</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/first/#grp._S_first">$first</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/last/">$last</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/max/">$max</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/min/">$min</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/push/">$push</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/addToSet/">$addToSet</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/stdDevPop/">$stdDevPop</a></li>
  <li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/stdDevSamp/">$stdDevSamp</a></li>
</ol>

<p>Como no outro exemplo fiz uma condição, no <em>aggregate</em> também podemos.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//exemplo 4</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pokemons</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
<span class="p">{</span><span class="na">$match</span><span class="p">:</span> <span class="p">{</span><span class="na">types</span><span class="p">:</span> <span class="s1">'fire'</span><span class="p">}},</span>
<span class="p">{</span>
  <span class="na">$group</span><span class="p">:{</span>
      <span class="na">_id</span><span class="p">:{},</span>
      <span class="na">media_defense</span><span class="p">:{</span> <span class="na">$avg</span><span class="p">:</span> <span class="s1">'$defense'</span><span class="p">},</span>
      <span class="na">media_atack</span><span class="p">:</span> <span class="p">{</span><span class="na">$avg</span><span class="p">:</span> <span class="s1">'$attack'</span><span class="p">},</span>
      <span class="na">defense</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="s1">'$defense'</span><span class="p">},</span>
      <span class="na">attack</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="s1">'$attack'</span><span class="p">},</span>
      <span class="na">total</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">}])</span></code></pre></figure>

<p>Resultado:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"result"</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"_id"</span><span class="p">:</span> <span class="p">{</span>

      <span class="p">},</span>
      <span class="s2">"media_defense"</span><span class="p">:</span> <span class="mf">67.20754716981132</span><span class="p">,</span>
      <span class="s2">"media_atack"</span><span class="p">:</span> <span class="mf">78.88679245283019</span><span class="p">,</span>
      <span class="s2">"defense"</span><span class="p">:</span> <span class="mi">3562</span><span class="p">,</span>
      <span class="s2">"attack"</span><span class="p">:</span> <span class="mi">4181</span><span class="p">,</span>
      <span class="s2">"total"</span><span class="p">:</span> <span class="mi">53</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">"ok"</span><span class="err">:</span> <span class="mi">1</span>
<span class="p">}</span></code></pre></figure>

<p><strong>Group</strong> e <strong>Aggregate</strong> são conceitos muitos importantes e usados. Na <a href="https://docs.mongodb.org/manual/">documentação</a> você pode encontrar mais exemplos.</p>

<h2 id="concluindo">Concluindo</h2>

<p>Aproveite para ler:</p>

<p><a href="https://docs.mongodb.org/master/MongoDB-aggregation-guide-master.pdf">MongoDB Aggregation and Data Processing</a></p>

<p><a href="http://www.amazon.com/MongoDB-Aggregation-Framework-Principles-Examples-ebook/dp/B00DGKGWE4/ref=pd_sim_351_9?ie=UTF8&amp;dpID=41Tand%2B2p1L&amp;dpSrc=sims&amp;preST=_UX300_PJku-sticker-v3%2CTopRight%2C0%2C-44_AC_UL160_SR100%2C160_&amp;refRID=082JMA3FA2NDBN7B7EXK" target="_blank">MongoDB Aggregation Framework Principles and Examples</a></p>

<p>E é isso, pratique e pratique, até a próxima.</p>

<p><img src="/images/mongodb123/bye.gif" /></p>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'victorvoid'; // required: replace example with your forum shortname
        var disqus_config = function () {
          this.page.url = 'http://victorvoid//2016-01-01-group-aggregate/';
          this.page.identifier = '/2016-01-01-group-aggregate';
          this.page.title = '';
        };
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2016 Victor Igor. All rights reserved.</span>
</footer> 

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

    </div>
  </body>
</html>